# Документ требований

## Введение

Zero Ground - это онлайн 2D шутер с видом сверху, с динамически генерируемыми картами и механикой тумана войны. Игра поддерживает многопользовательский геймплей по локальной сети, используя клиент-серверную архитектуру с библиотекой SFML 2.6.1. Сервер хостит игровую сессию и управляет одним игроком (зелёный круг), в то время как клиенты подключаются для игры в качестве дополнительных игроков (синие круги). Игра включает обнаружение столкновений со случайно сгенерированными стенами, систему видимости на основе расстояния и синхронизацию в реальном времени.

## Глоссарий

- **Сервер**: Хост-приложение, которое управляет состоянием игры, генерирует карту и управляет зелёным персонажем игрока
- **Клиент**: Приложение игрока, которое подключается к серверу и управляет синим персонажем игрока
- **Карта**: Игровой мир размером 500x500 единиц, содержащий стены и точки спавна игроков, масштабируемый под разрешение экрана
- **Стена**: Прямоугольные препятствия, которые блокируют движение игрока и всегда видимы, но затемнены вне радиуса видимости
- **Туман войны**: Система визуального затемнения, которая ограничивает видимость игрока радиусом 25 единиц вокруг персонажа
- **Радиус видимости**: Круговая область в 25 единиц вокруг игрока, где другие игроки и полные детали видимы
- **Сетевой пакет**: UDP структура данных, содержащая позицию игрока, статус жизни и ID кадра для синхронизации
- **BFS**: Алгоритм поиска в ширину, используемый для проверки связности карты между точками спавна
- **Точка спавна**: Начальная позиция игрока на карте (нижний левый угол для сервера, верхний правый для клиента)
- **HUD**: Интерфейс, показывающий полоску здоровья игрока и счёт убийств
- **Столкновение**: Физическое взаимодействие, когда игрок контактирует со стеной, приводящее к немедленной остановке и отталкиванию на 1 единицу

## Requirements

### Требование 1: Генерация и валидация карты

**Пользовательская история:** Как оператор сервера, я хочу, чтобы система генерировала валидную играбельную карту со стенами и проверенной связностью, чтобы все игроки могли перемещаться по всему игровому миру.

#### Критерии приёмки

1. КОГДА сервер запускается, ТОГДА система ДОЛЖНА сгенерировать карту размером 500x500 единиц, масштабированную под текущее разрешение экрана
2. КОГДА генерируются стены, ТОГДА система ДОЛЖНА создавать случайные прямоугольные стены с шириной от 2 до 8 единиц и высотой от 2 до 8 единиц
3. КОГДА рассчитывается общее покрытие стенами, ТОГДА система ДОЛЖНА обеспечить, чтобы стены занимали от 25% до 35% общей площади карты
4. КОГДА валидируется связность карты, ТОГДА система ДОЛЖНА использовать алгоритм BFS для проверки существования пути между точкой спавна сервера (нижний левый угол) и точкой спавна клиента (верхний правый угол)
5. ЕСЛИ не существует валидного пути между точками спавна, ТОГДА система ДОЛЖНА перегенерировать карту с максимумом 10 попыток
6. КОГДА все попытки генерации неудачны, ТОГДА система ДОЛЖНА отобразить сообщение об ошибке и корректно завершить работу

### Требование 2: Движение игрока и столкновения

**Пользовательская история:** Как игрок, я хочу плавное движение персонажа с правильным обнаружением столкновений, чтобы я мог перемещаться по карте без прохождения сквозь стены.

#### Критерии приёмки

1. КОГДА игрок нажимает клавиши движения (WASD), ТОГДА система ДОЛЖНА обновлять позицию игрока, используя координаты с плавающей точкой со скоростью 5 единиц в секунду
2. КОГДА игрок сервера нажимает клавиши WASD, ТОГДА система ДОЛЖНА двигать только зелёный круг
3. КОГДА игрок клиента нажимает клавиши WASD, ТОГДА система ДОЛЖНА двигать только синий круг этого клиента
4. КОГДА игрок сталкивается со стеной, ТОГДА система ДОЛЖНА немедленно остановить движение игрока
5. КОГДА происходит столкновение, ТОГДА система ДОЛЖНА оттолкнуть игрока на 1 единицу, чтобы предотвратить проникновение в стену
6. КОГДА игрок достигает границ карты, ТОГДА система ДОЛЖНА ограничить позицию игрока в пределах валидных координат карты

### Требование 3: Система видимости тумана войны

**Пользовательская история:** Как игрок, я хочу ограниченную видимость вокруг моего персонажа с туманом войны, чтобы игра имела стратегическую глубину и элементы исследования.

#### Критерии приёмки

1. КОГДА отрисовывается игровой вид, ТОГДА система ДОЛЖНА отображать радиус видимости 25 единиц вокруг персонажа игрока
2. КОГДА отрисовываются области вне радиуса видимости, ТОГДА система ДОЛЖНА накладывать чёрный полупрозрачный прямоугольник со значением альфа 200
3. КОГДА другой игрок находится в пределах 25 единиц, ТОГДА система ДОЛЖНА отрисовать этого игрока полностью видимым
4. КОГДА другой игрок находится за пределами 25 единиц, ТОГДА система НЕ ДОЛЖНА отрисовывать этого игрока
5. КОГДА отрисовываются стены, ТОГДА система ДОЛЖНА всегда отображать все стены на карте независимо от расстояния
6. КОГДА отрисовываются стены вне радиуса видимости, ТОГДА система ДОЛЖНА применять эффект затемнения к этим стенам

### Требование 4: Сетевая архитектура и синхронизация

**Пользовательская история:** Как системный архитектор, я хочу надёжную клиент-серверную сетевую коммуникацию с правильной синхронизацией состояния, чтобы все игроки видели согласованное состояние игры.

#### Критерии приёмки

1. КОГДА сервер запускается, ТОГДА система ДОЛЖНА привязать TCP сокет к порту 53000 для начальных подключений
2. КОГДА сервер запускается, ТОГДА система ДОЛЖНА привязать UDP сокет к порту 53001 для обновлений позиций
3. КОГДА клиент подключается, ТОГДА система ДОЛЖНА отправить полное состояние карты, включая все координаты стен через TCP
4. КОГДА клиент подключается, ТОГДА система ДОЛЖНА отправить начальные позиции всех игроков через TCP
5. КОГДА синхронизируются позиции, ТОГДА система ДОЛЖНА отправлять UDP пакеты с частотой 20 пакетов в секунду
6. КОГДА создаются сетевые пакеты, ТОГДА система ДОЛЖНА включать координату x игрока, координату y, статус жизни и ID кадра
7. КОГДА сервер обнаруживает игрока в пределах 50 единиц, ТОГДА система ДОЛЖНА включать данные этого игрока в сетевые обновления
8. КОГДА сервер обнаруживает игрока за пределами 50 единиц, ТОГДА система ДОЛЖНА исключать данные этого игрока из сетевых обновлений для оптимизации пропускной способности

### Требование 5: Управление подключением и обработка ошибок

**Пользовательская история:** Как игрок, я хочу чёткую обратную связь о статусе подключения и возможность переподключиться, чтобы я мог восстановиться после сетевых проблем.

#### Критерии приёмки

1. КОГДА клиент теряет соединение более чем на 2 секунды, ТОГДА система ДОЛЖНА отобразить сообщение "Соединение потеряно. Нажмите R для переподключения к [IP]"
2. КОГДА клиент нажимает R на экране переподключения, ТОГДА система ДОЛЖНА попытаться переподключиться к последнему известному IP адресу сервера
3. КОГДА клиент пытается подключиться к невалидному IP, ТОГДА система ДОЛЖНА отобразить "Сервер недоступен. Проверьте IP и попробуйте снова" красным текстом на 3 секунды
4. КОГДА сетевые пакеты не проходят валидацию, ТОГДА система ДОЛЖНА отбросить невалидные пакеты и залогировать ошибку
5. КОГДА валидируются полученные данные позиции, ТОГДА система ДОЛЖНА проверить, что координаты x и y находятся в пределах границ карты (0-500)

### Требование 6: Пользовательский интерфейс сервера и готовность игрока

**Пользовательская история:** Как оператор сервера, я хочу чёткий интерфейс, показывающий статус сервера, информацию о подключении и состояние готовности игрока, чтобы я мог координировать старт игры с подключёнными игроками.

#### Критерии приёмки

1. КОГДА приложение сервера запускается, ТОГДА система ДОЛЖНА отобразить стартовый экран в полноэкранном режиме
2. КОГДА отображается стартовый экран, ТОГДА система ДОЛЖНА показать текст "СЕРВЕР ЗАПУЩЕН" зелёным цветом размером 64pt
3. КОГДА отображается стартовый экран, ТОГДА система ДОЛЖНА показать текст "IP сервера: [реальный локальный IP]" белым цветом размером 32pt
4. ЕСЛИ локальный IP 127.0.0.1 или 0.0.0.0, ТОГДА система ДОЛЖНА отобразить "IP недоступен" вместо IP адреса
5. КОГДА отображается стартовый экран, ТОГДА система ДОЛЖНА показать текст "Ожидание игрока..." белым цветом размером 28pt
6. КОГДА клиент успешно подключается, ТОГДА система ДОЛЖНА заменить "Ожидание игрока..." на текст "Игрок подключён, но не готов" жёлтым цветом размером 28pt
7. КОГДА подключённый клиент нажимает кнопку Готов, ТОГДА система ДОЛЖНА заменить текст статуса на "Игрок подключён и готов играть" зелёным цветом размером 28pt
8. КОГДА статус игрока показывает готовность, ТОГДА система ДОЛЖНА отобразить зелёную кнопку "ИГРАТЬ" размером 200x60 пикселей
9. КОГДА оператор нажимает кнопку ИГРАТЬ, ТОГДА система ДОЛЖНА отправить сигнал старта игры всем клиентам и перейти на главный игровой экран
10. КОГДА оператор нажимает клавишу Escape, ТОГДА система ДОЛЖНА переключаться между полноэкранным и оконным режимом

### Требование 7: Пользовательский интерфейс клиента и система готовности

**Пользовательская история:** Как игрок клиента, я хочу интуитивный интерфейс подключения с подтверждением готовности, чтобы я мог координировать старт игры с сервером.

#### Критерии приёмки

1. КОГДА приложение клиента запускается, ТОГДА система ДОЛЖНА отобразить экран подключения в полноэкранном режиме
2. КОГДА отображается экран подключения, ТОГДА система ДОЛЖНА показать метку "IP АДРЕС СЕРВЕРА:" белым цветом размером 32pt
3. КОГДА отображается экран подключения, ТОГДА система ДОЛЖНА показать поле ввода размером 400x50 пикселей с тёмно-серым фоном
4. КОГДА поле ввода в фокусе, ТОГДА система ДОЛЖНА изменить цвет обводки на зелёный с толщиной 3 пикселя
5. КОГДА пользователь печатает в поле ввода, ТОГДА система ДОЛЖНА принимать только цифры (0-9) и точки (.)
6. КОГДА пользователь нажимает Backspace в поле ввода, ТОГДА система ДОЛЖНА удалить последний символ
7. КОГДА поле ввода содержит текст, ТОГДА система ДОЛЖНА ограничить ввод максимум 15 символами
8. КОГДА отображается экран подключения, ТОГДА система ДОЛЖНА показать зелёную кнопку "ПОДКЛЮЧИТЬСЯ К СЕРВЕРУ" размером 300x70 пикселей
9. КОГДА пользователь нажимает кнопку подключения или нажимает Enter, ТОГДА система ДОЛЖНА попытаться установить TCP подключение к введённому IP адресу на порту 53000 с таймаутом 3 секунды
10. КОГДА подключение неудачно, ТОГДА система ДОЛЖНА отобразить "СЕРВЕР НЕДОСТУПЕН ИЛИ НЕВАЛИДНЫЙ IP" красным текстом на 3 секунды
11. КОГДА подключение успешно, ТОГДА система ДОЛЖНА отобразить текст "Соединение установлено" зелёным цветом размером 32pt
12. КОГДА подключение успешно, ТОГДА система ДОЛЖНА отобразить зелёную кнопку "ГОТОВ" размером 200x60 пикселей
13. КОГДА пользователь нажимает кнопку ГОТОВ, ТОГДА система ДОЛЖНА отправить статус готовности серверу
14. КОГДА статус готовности отправлен, ТОГДА система ДОЛЖНА заменить кнопку ГОТОВ на текст "Ожидание старта игры..." жёлтым цветом размером 28pt
15. КОГДА сервер отправляет сигнал старта игры, ТОГДА система ДОЛЖНА перейти на главный игровой экран
16. КОГДА пользователь нажимает клавишу Escape, ТОГДА система ДОЛЖНА переключаться между полноэкранным и оконным режимом

### Требование 8: Протокол готовности игрока

**Пользовательская история:** Как системный архитектор, я хочу надёжный протокол проверки готовности между сервером и клиентами, чтобы игра начиналась только когда все игроки подготовлены.

#### Критерии приёмки

1. КОГДА клиент подключается через TCP, ТОГДА система ДОЛЖНА отправить пакет подтверждения подключения серверу
2. КОГДА сервер получает подтверждение подключения, ТОГДА система ДОЛЖНА обновить UI сервера для отображения статуса подключённого игрока
3. КОГДА клиент нажимает кнопку ГОТОВ, ТОГДА система ДОЛЖНА отправить пакет статуса готовности серверу через TCP
4. КОГДА сервер получает статус готовности, ТОГДА система ДОЛЖНА обновить UI сервера для отображения статуса готовности игрока
5. КОГДА оператор сервера нажимает кнопку ИГРАТЬ, ТОГДА система ДОЛЖНА отправить сигнал старта игры всем подключённым клиентам через TCP
6. КОГДА клиент получает сигнал старта игры, ТОГДА система ДОЛЖНА загрузить данные карты и перейти на игровой экран
7. КОГДА сервер отправляет сигнал старта игры, ТОГДА система ДОЛЖНА перейти на игровой экран одновременно с клиентами

### Требование 9: Игровой HUD и визуальная обратная связь

**Пользовательская история:** Как игрок, я хочу видеть статус моего здоровья и игровой счёт, чтобы я мог отслеживать свою производительность во время игры.

#### Критерии приёмки

1. КОГДА отрисовывается игровой экран, ТОГДА система ДОЛЖНА отображать полоску здоровья над персонажем игрока
2. КОГДА у игрока 100 HP, ТОГДА система ДОЛЖНА отрисовать полоску здоровья как зелёный прямоугольник
3. КОГДА здоровье игрока уменьшается, ТОГДА система ДОЛЖНА пропорционально уменьшить ширину полоски здоровья
4. КОГДА отрисовывается игровой экран, ТОГДА система ДОЛЖНА отображать текст "Счёт: [число]" в верхнем левом углу
5. КОГДА игрок умирает, ТОГДА система ДОЛЖНА применить эффект затемнения всего экрана

### Требование 10: Потокобезопасность и валидация данных

**Пользовательская история:** Как системный архитектор, я хочу потокобезопасный доступ к общему состоянию игры и валидированные сетевые данные, чтобы приложение оставалось стабильным при конкурентных операциях.

#### Критерии приёмки

1. КОГДА осуществляется доступ к общим позициям игроков, ТОГДА система ДОЛЖНА использовать std::mutex для защиты конкурентных операций чтения и записи
2. КОГДА осуществляется доступ к общим данным карты, ТОГДА система ДОЛЖНА использовать std::mutex для защиты конкурентных операций чтения и записи
3. КОГДА получаются сетевые данные позиции, ТОГДА система ДОЛЖНА валидировать, что координата x находится между 0 и 500
4. КОГДА получаются сетевые данные позиции, ТОГДА система ДОЛЖНА валидировать, что координата y находится между 0 и 500
5. ЕСЛИ полученные координаты находятся вне валидного диапазона, ТОГДА система ДОЛЖНА отбросить пакет и продолжить обработку

### Требование 11: Производительность и оптимизация

**Пользовательская история:** Как игрок, я хочу плавный геймплей с постоянной частотой кадров, чтобы у меня был отзывчивый игровой опыт.

#### Критерии приёмки

1. КОГДА запускается на системе с Intel i3-8100 и 8GB RAM, ТОГДА система ДОЛЖНА поддерживать минимум 55 FPS
2. КОГДА подключены два игрока, ТОГДА система ДОЛЖНА использовать менее 40% CPU
3. КОГДА обнаруживаются столкновения, ТОГДА система ДОЛЖНА использовать пространственное разбиение (quadtree) для оптимизации
4. КОГДА отрисовывается движение игрока, ТОГДА система ДОЛЖНА использовать линейную интерполяцию между предыдущей и целевой позициями для плавной анимации
5. КОГДА частота кадров падает ниже 55 FPS, ТОГДА система ДОЛЖНА логировать метрики производительности для отладки
