# Реализация покупки оружия в магазине

## Описание изменений

Добавлена полная функциональность покупки оружия в магазине. Каждый игрок покупает оружие локально, без синхронизации с другими игроками.

## Архитектура решения

### Клиентская часть (Zero_Ground_client.cpp)

1. **Обработка кликов в UI магазина**:
   - При клике левой кнопкой мыши в открытом магазине определяется, на какое оружие кликнули
   - Проверяется статус покупки (достаточно денег, есть место в инвентаре)
   - Если покупка возможна, вызывается `processPurchase()` локально
   - Инвентарь и деньги обновляются только у текущего игрока

### Серверная часть (Zero_Ground.cpp)

1. **Локальная покупка хоста**:
   - Хост обрабатывает клики в UI магазина
   - При клике на оружие вызывается `processPurchase()` локально
   - Инвентарь и деньги обновляются только у хоста
   - Никакие данные не отправляются клиентам

## Протокол передачи данных

Покупки обрабатываются локально на каждом клиенте, поэтому сетевые пакеты не используются.

## Последовательность покупки

### Покупка любым игроком:

1. Игрок кликает на оружие в UI магазина
2. Проверяется статус покупки локально (достаточно денег, есть место)
3. Если можно купить, вызывается `processPurchase()` локально
4. Обновляется инвентарь и деньги только у текущего игрока
5. Другие игроки не видят эту покупку

## Добавленный код

### Zero_Ground_client.cpp

**Обработка кликов в магазине** (строки ~2668):
- Определение координат клика
- Расчет границ панелей оружия с учетом анимации
- Проверка попадания клика в панель оружия
- Вызов `processPurchase()` при успешной покупке
- Локальное обновление инвентаря и денег

### Zero_Ground.cpp

**Обработка кликов в магазине** (строки ~3985):
- Определение координат клика
- Расчет границ панелей оружия с учетом анимации
- Проверка попадания клика в панель оружия
- Вызов `processPurchase()` при успешной покупке
- Локальное обновление инвентаря и денег

## Валидация покупки

Функция `processPurchase()` проверяет:

1. **Достаточно денег**: `player.money >= weapon->price`
2. **Есть место в инвентаре**: `player.hasInventorySpace()`
3. **Корректный тип оружия**: валидный `Weapon::Type`

При успешной покупке:
- Вычитаются деньги: `player.money -= weapon->price`
- Оружие добавляется в первый пустой слот
- Оружие инициализируется с полным магазином и резервом

## Визуальная обратная связь

В UI магазина отображается:
- **Зеленая рамка**: оружие можно купить
- **Серая рамка**: недостаточно денег или инвентарь полон
- **Текст статуса**:
  - "Can purchase" (зеленый)
  - "Insufficient funds. Required: $X" (красный)
  - "Inventory full. Free a slot to purchase." (желтый)

## Логирование

Все операции покупки логируются:
- Клиент: "Client player purchased [weapon name]"
- Сервер: "Server player purchased [weapon name]"
- При ошибках: "Cannot purchase [weapon name]: [reason]"

## Тестирование

Для проверки работы:

1. Запустите сервер и клиента
2. Подойдите к магазину (красный квадрат)
3. Нажмите B для открытия магазина
4. Кликните на оружие, которое можете купить (зеленая рамка)
5. Проверьте:
   - Деньги уменьшились
   - Оружие появилось в инвентаре (нажмите E)
   - Можно переключиться на оружие (клавиши 1-4)
   - Другой игрок НЕ видит вашу покупку (каждый покупает для себя)

## Известные ограничения

1. **Локальные покупки**: Каждый игрок покупает только для себя, другие игроки не видят покупки
2. **Размер инвентаря**: Фиксированный размер 4 слота
3. **Удаление оружия**: Нет функции продажи или выброса оружия
4. **Цены**: Фиксированные цены, нет скидок или динамического ценообразования

## Возможные улучшения

1. Добавить звуковые эффекты при покупке
2. Добавить анимацию добавления оружия в инвентарь
3. Добавить подтверждение покупки для дорогих предметов
4. Добавить возможность продажи оружия обратно
5. Добавить систему скидок или специальных предложений
